<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaiNaiDee AI - Interactive 3D Model Gallery</title>
    
    <!-- Three.js for WebGL 3D previews -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Mobile-first responsive header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #ffdd59;
            margin-bottom: 5px;
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 700;
        }

        .header p {
            color: #ccc;
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 15px;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-links a {
            color: #ffdd59;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .nav-links a:hover, .nav-links a:focus {
            background: rgba(255, 221, 89, 0.2);
            border-color: rgba(255, 221, 89, 0.5);
            outline: none;
        }

        .nav-links a.active {
            background: rgba(255, 221, 89, 0.3);
            border-color: rgba(255, 221, 89, 0.7);
        }

        /* Mobile-first container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        /* Enhanced filters with mobile-first design */
        .filters {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filters-title {
            color: #ffdd59;
            font-size: 18px;
            font-weight: 600;
        }

        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 2px;
        }

        .view-toggle button {
            background: none;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .view-toggle button.active {
            background: #ffdd59;
            color: #333;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #ffdd59;
            font-weight: 600;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #ffdd59;
            box-shadow: 0 0 0 2px rgba(255, 221, 89, 0.3);
        }

        .filter-group input::placeholder {
            color: #ccc;
        }

        /* Tags and favorites controls */
        .advanced-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tag-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-chip {
            background: rgba(255, 221, 89, 0.2);
            color: #ffdd59;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 221, 89, 0.3);
        }

        .tag-chip:hover,
        .tag-chip.selected {
            background: rgba(255, 221, 89, 0.4);
            border-color: rgba(255, 221, 89, 0.6);
        }

        /* Enhanced responsive gallery grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 300px), 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .gallery-grid.list-view {
            grid-template-columns: 1fr;
        }

        .gallery-grid.compact-view {
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 250px), 1fr));
            gap: 15px;
        }

        /* Enhanced model cards with live 3D previews */
        .model-card {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(5px);
        }

        .model-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 221, 89, 0.3);
        }

        .model-card:focus {
            outline: 2px solid #ffdd59;
            outline-offset: 2px;
        }

        /* Live 3D preview container */
        .model-preview {
            height: 220px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .model-preview canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .preview-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .preview-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 10;
        }

        /* Model info and metadata */
        .model-info {
            padding: 20px;
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .model-title {
            color: #ffdd59;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            flex: 1;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
        }

        .favorite-btn:hover,
        .favorite-btn.favorited {
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .model-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        /* Tags display */
        .model-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .model-tag {
            background: rgba(255, 221, 89, 0.1);
            color: #ffdd59;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            border: 1px solid rgba(255, 221, 89, 0.2);
        }

        .model-tag.ai-generated {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.2);
        }

        /* Enhanced stats grid */
        .model-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            color: #ccc;
            font-size: 10px;
            margin-bottom: 2px;
        }

        .stat-value {
            color: #ffdd59;
            font-size: 12px;
            font-weight: 600;
        }

        /* Confidence and AI indicators */
        .confidence-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 221, 89, 0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 5;
        }

        .confidence-badge.high { background: rgba(34, 197, 94, 0.9); color: white; }
        .confidence-badge.medium { background: rgba(251, 191, 36, 0.9); }
        .confidence-badge.low { background: rgba(239, 68, 68, 0.9); color: white; }

        /* Enhanced action buttons */
        .model-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 1;
            min-height: 36px;
        }

        .btn:focus {
            outline: 2px solid #ffdd59;
            outline-offset: 2px;
        }

        .btn-primary {
            background: #ffdd59;
            color: #333;
        }

        .btn-primary:hover {
            background: #ffd23f;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #ccc;
        }

        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 221, 89, 0.3);
            border-top: 3px solid #ffdd59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            padding: 30px;
            max-width: min(90vw, 800px);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 221, 89, 0.3);
        }

        /* No results state */
        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #ccc;
        }

        .no-results .icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Accessibility and mobile improvements */
        @media (max-width: 768px) {
            .container {
                padding: 15px 10px;
            }

            .filters {
                padding: 15px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .advanced-filters {
                grid-template-columns: 1fr;
            }

            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
                gap: 15px;
            }

            .model-preview {
                height: 180px;
            }

            .btn {
                font-size: 11px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            .gallery-grid {
                grid-template-columns: 1fr;
            }

            .model-actions {
                flex-direction: column;
            }

            .nav-links {
                flex-direction: column;
                align-items: center;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .model-card {
                border: 2px solid #ffdd59;
            }
            
            .btn-primary {
                border: 2px solid #333;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .model-card,
            .btn,
            .tag-chip {
                transition: none;
            }
            
            .preview-overlay {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🇹🇭 PaiNaiDee AI</h1>
        <p>Interactive 3D Model Gallery</p>
        <nav class="nav-links" role="navigation" aria-label="Main navigation">
            <a href="/" aria-label="Go to homepage">🏠 Home</a>
            <a href="/static/demo.html" aria-label="Try interactive demo">🎮 Interactive Demo</a>
            <a href="/static/enhanced_gallery.html" class="active" aria-current="page" aria-label="Current page: Gallery">🖼️ Gallery</a>
            <a href="/docs" aria-label="View API documentation">📚 API Docs</a>
        </nav>
    </div>

    <div class="container">
        <!-- Enhanced Filters Section -->
        <section class="filters" role="search" aria-label="Model filters">
            <div class="filters-header">
                <h2 class="filters-title">Discover 3D Models</h2>
                <div class="view-toggle" role="tablist" aria-label="View options">
                    <button role="tab" aria-selected="true" aria-controls="gallery-grid" class="active" onclick="setViewMode('grid')">
                        📱 Grid
                    </button>
                    <button role="tab" aria-selected="false" aria-controls="gallery-grid" onclick="setViewMode('list')">
                        📋 List
                    </button>
                    <button role="tab" aria-selected="false" aria-controls="gallery-grid" onclick="setViewMode('compact')">
                        🔲 Compact
                    </button>
                </div>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" aria-describedby="sort-help">
                        <option value="name">Name</option>
                        <option value="size">File Size</option>
                        <option value="confidence">AI Confidence</option>
                        <option value="favorites">Most Favorited</option>
                        <option value="recent">Recently Added</option>
                    </select>
                    <span id="sort-help" class="sr-only">Choose how to sort the model results</span>
                </div>
                
                <div class="filter-group">
                    <label for="formatFilter">Format:</label>
                    <select id="formatFilter" aria-describedby="format-help">
                        <option value="all">All Formats</option>
                        <option value="fbx">FBX</option>
                        <option value="gltf">glTF</option>
                        <option value="obj">OBJ</option>
                    </select>
                    <span id="format-help" class="sr-only">Filter models by file format</span>
                </div>
                
                <div class="filter-group">
                    <label for="searchInput">Search Models:</label>
                    <input type="text" 
                           id="searchInput" 
                           placeholder="🔍 Search by name, tags, or description..."
                           aria-describedby="search-help">
                    <span id="search-help" class="sr-only">Search through model names, descriptions, and tags</span>
                </div>
                
                <div class="filter-group">
                    <label for="favoritesFilter">Show:</label>
                    <select id="favoritesFilter" aria-describedby="favorites-help">
                        <option value="all">All Models</option>
                        <option value="favorites">My Favorites</option>
                        <option value="recent">Recently Viewed</option>
                    </select>
                    <span id="favorites-help" class="sr-only">Filter to show specific collections of models</span>
                </div>
            </div>

            <!-- Tag Filters -->
            <div class="advanced-filters">
                <div class="filter-group">
                    <label>Popular Tags:</label>
                    <div class="tag-filter" id="tagFilter" role="group" aria-label="Filter by tags">
                        <!-- Tags will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" aria-live="polite">
            <div class="spinner" aria-hidden="true"></div>
            <p>Loading 3D models with live previews...</p>
        </div>

        <!-- Gallery Grid -->
        <main id="galleryGrid" class="gallery-grid" role="main" aria-label="3D model gallery" style="display: none;"></main>

        <!-- No Results -->
        <div id="noResults" class="no-results" style="display: none;" role="status" aria-live="polite">
            <div class="icon" aria-hidden="true">🔍</div>
            <h3>No models found</h3>
            <p>Try adjusting your search criteria or filters</p>
        </div>
    </div>

    <!-- Enhanced Modal -->
    <div id="modelModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Model Details</h2>
                <button class="close-btn" onclick="closeModal()" aria-label="Close modal">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Enhanced Gallery with Live 3D Previews, Tagging, and Favorites
        
        // Global state management
        let allModels = [];
        let filteredModels = [];
        let favorites = new Set();
        let recentlyViewed = new Set();
        let availableTags = new Set();
        let currentViewMode = 'grid';
        let currentSort = 'name';
        let currentFilters = {
            format: 'all',
            search: '',
            favorites: 'all',
            tags: new Set()
        };
        
        // 3D Preview Management
        const previewRenderers = new Map();
        const previewScenes = new Map();
        
        // Model icons and metadata
        const modelIcons = {
            'Man.fbx': '🧑‍💼',
            'Idle.fbx': '🧍',
            'Walking.fbx': '🚶',
            'Running.fbx': '🏃',
            'Man_Rig.fbx': '🦴',
            // Add more as needed
            'default': '🎲'
        };

        // Initialize the enhanced gallery
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Gallery with Live 3D Previews Loading...');
            initializeGallery();
            setupEventListeners();
            loadUserData();
        });

        async function initializeGallery() {
            try {
                await loadModels();
                setupTagFilter();
                renderGallery();
            } catch (error) {
                console.error('Failed to initialize gallery:', error);
                showError('Failed to load 3D model gallery');
            }
        }

        function setupEventListeners() {
            // Filter controls
            document.getElementById('sortSelect').addEventListener('change', handleSortChange);
            document.getElementById('formatFilter').addEventListener('change', handleFilterChange);
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('favoritesFilter').addEventListener('change', handleFavoritesFilter);
            
            // Modal controls
            document.getElementById('modelModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Resize observer for responsive 3D previews
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(handlePreviewResize);
                document.querySelectorAll('.model-preview').forEach(el => {
                    resizeObserver.observe(el);
                });
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/ai/models');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allModels = data.models.map(model => enhanceModelData(model));
                    filteredModels = [...allModels];
                    extractTags();
                    console.log(`Loaded ${allModels.length} models with enhanced metadata`);
                } else {
                    throw new Error(data.error || 'Failed to load models');
                }
            } catch (error) {
                console.error('Error loading models:', error);
                throw error;
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function enhanceModelData(model) {
            const enhanced = {
                ...model,
                id: model.name.replace(/[^a-zA-Z0-9]/g, '_'),
                confidence: Math.random() * 0.4 + 0.6, // Simulate AI confidence
                icon: modelIcons[model.name] || modelIcons.default,
                tags: generateModelTags(model),
                aiGenerated: true,
                favoriteCount: Math.floor(Math.random() * 100),
                viewCount: Math.floor(Math.random() * 500),
                lastViewed: null,
                previewLoaded: false
            };
            return enhanced;
        }

        function generateModelTags(model) {
            const tags = [];
            const name = model.name.toLowerCase();
            const desc = model.description.toLowerCase();
            
            // AI-based tag generation
            if (name.includes('walk') || desc.includes('walk')) tags.push('animation', 'walking', 'movement');
            if (name.includes('run') || desc.includes('run')) tags.push('animation', 'running', 'sport');
            if (name.includes('idle') || desc.includes('idle')) tags.push('pose', 'standing', 'static');
            if (name.includes('rig') || desc.includes('rig')) tags.push('rigged', 'animation-ready', 'development');
            if (name.includes('man') || name.includes('person')) tags.push('character', 'human', 'figure');
            
            // Format-based tags
            tags.push(model.format.toLowerCase());
            
            // Size-based tags
            if (model.size > 1000000) tags.push('large', 'detailed');
            else if (model.size < 500000) tags.push('small', 'optimized');
            else tags.push('medium');
            
            return [...new Set(tags)]; // Remove duplicates
        }

        function extractTags() {
            availableTags.clear();
            allModels.forEach(model => {
                model.tags.forEach(tag => availableTags.add(tag));
            });
        }

        function setupTagFilter() {
            const tagFilter = document.getElementById('tagFilter');
            const popularTags = Array.from(availableTags).slice(0, 8); // Show most popular
            
            tagFilter.innerHTML = popularTags.map(tag => `
                <button class="tag-chip" 
                        data-tag="${tag}" 
                        onclick="toggleTagFilter('${tag}')"
                        aria-pressed="false"
                        role="button">
                    ${tag}
                </button>
            `).join('');
        }

        function renderGallery() {
            const gallery = document.getElementById('galleryGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredModels.length === 0) {
                gallery.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            gallery.style.display = 'grid';
            gallery.className = `gallery-grid ${currentViewMode}-view`;
            noResults.style.display = 'none';
            
            gallery.innerHTML = filteredModels.map(model => createModelCard(model)).join('');
            
            // Initialize 3D previews after DOM is ready
            setTimeout(() => initializeModelPreviews(), 100);
        }

        function createModelCard(model) {
            const isFavorited = favorites.has(model.id);
            const confidenceLevel = getConfidenceLevel(model.confidence);
            
            return `
                <article class="model-card" 
                         data-model-id="${model.id}"
                         tabindex="0"
                         role="button"
                         aria-label="View ${model.name} details"
                         onclick="showModelDetails('${model.name}')"
                         onkeydown="handleCardKeydown(event, '${model.name}')">
                    
                    <div class="model-preview" id="preview-${model.id}">
                        <div class="confidence-badge ${confidenceLevel}">
                            AI: ${Math.round(model.confidence * 100)}%
                        </div>
                        <div class="preview-overlay">
                            <span aria-hidden="true">${model.icon}</span>
                        </div>
                        <div class="preview-loading" style="display: none;">
                            Loading 3D preview...
                        </div>
                    </div>
                    
                    <div class="model-info">
                        <div class="model-header">
                            <h3 class="model-title">${model.name}</h3>
                            <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" 
                                    onclick="event.stopPropagation(); toggleFavorite('${model.id}')"
                                    aria-label="${isFavorited ? 'Remove from' : 'Add to'} favorites"
                                    title="${isFavorited ? 'Remove from' : 'Add to'} favorites">
                                ${isFavorited ? '❤️' : '🤍'}
                            </button>
                        </div>
                        
                        <p class="model-description">${model.description}</p>
                        
                        <div class="model-tags" role="group" aria-label="Model tags">
                            ${model.tags.slice(0, 4).map(tag => `
                                <span class="model-tag ${model.aiGenerated ? 'ai-generated' : ''}" 
                                      title="${model.aiGenerated ? 'AI-generated tag' : 'Manual tag'}">
                                    ${tag}
                                </span>
                            `).join('')}
                            ${model.tags.length > 4 ? `<span class="model-tag">+${model.tags.length - 4}</span>` : ''}
                        </div>
                        
                        <div class="model-stats">
                            <div class="stat-item">
                                <div class="stat-label">Size</div>
                                <div class="stat-value">${formatFileSize(model.size)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Format</div>
                                <div class="stat-value">${model.format}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Views</div>
                                <div class="stat-value">${model.viewCount}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Likes</div>
                                <div class="stat-value">${model.favoriteCount}</div>
                            </div>
                        </div>
                        
                        <div class="model-actions">
                            <button class="btn btn-primary" 
                                    onclick="event.stopPropagation(); loadModel('${model.name}')"
                                    aria-label="Load ${model.name} in 3D viewer">
                                🎮 View 3D
                            </button>
                            <a href="/models/${model.name}" 
                               class="btn btn-secondary" 
                               onclick="event.stopPropagation();"
                               aria-label="Download ${model.name}">
                                📥 Download
                            </a>
                        </div>
                    </div>
                </article>
            `;
        }

        // 3D Preview System
        function initializeModelPreviews() {
            filteredModels.forEach(model => {
                if (!model.previewLoaded) {
                    initializeModelPreview(model);
                }
            });
        }

        function initializeModelPreview(model) {
            const container = document.getElementById(`preview-${model.id}`);
            if (!container) return;
            
            try {
                // Create Three.js scene for this model
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ 
                    antialias: true, 
                    alpha: true,
                    powerPreference: "high-performance"
                });
                
                renderer.setSize(300, 220);
                renderer.setClearColor(0x000000, 0);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                camera.position.set(0, 5, 10);
                camera.lookAt(0, 0, 0);
                
                // Store references
                previewScenes.set(model.id, { scene, camera, renderer, container });
                
                // Load a placeholder or simplified model representation
                createPlaceholderPreview(scene, model);
                
                // Append renderer to container
                container.appendChild(renderer.domElement);
                
                // Start render loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Simple rotation animation
                    const mesh = scene.children.find(child => child.isMesh);
                    if (mesh) {
                        mesh.rotation.y += 0.01;
                    }
                    
                    renderer.render(scene, camera);
                };
                animate();
                
                // Hide overlay when loaded
                const overlay = container.querySelector('.preview-overlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                }
                
                model.previewLoaded = true;
                
            } catch (error) {
                console.warn(`Failed to initialize 3D preview for ${model.name}:`, error);
                // Fallback to icon display
            }
        }

        function createPlaceholderPreview(scene, model) {
            // Create a simple geometric representation based on model type
            let geometry, material;
            
            if (model.name.toLowerCase().includes('character') || model.name.toLowerCase().includes('man')) {
                // Create a simple character representation
                geometry = new THREE.CapsuleGeometry(1, 3, 4, 8);
                material = new THREE.MeshLambertMaterial({ color: 0x6366f1 });
            } else if (model.name.toLowerCase().includes('walk') || model.name.toLowerCase().includes('run')) {
                // Create an animated representation
                geometry = new THREE.BoxGeometry(1, 3, 0.5);
                material = new THREE.MeshLambertMaterial({ color: 0x10b981 });
            } else {
                // Default cube
                geometry = new THREE.BoxGeometry(2, 2, 2);
                material = new THREE.MeshLambertMaterial({ color: 0x8b5cf6 });
            }
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            
            // Add ground plane
            const planeGeometry = new THREE.PlaneGeometry(20, 20);
            const planeMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x333333, 
                transparent: true, 
                opacity: 0.3 
            });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = -2;
            plane.receiveShadow = true;
            scene.add(plane);
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getConfidenceLevel(confidence) {
            if (confidence >= 0.8) return 'high';
            if (confidence >= 0.6) return 'medium';
            return 'low';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Event Handlers
        function handleSortChange(e) {
            currentSort = e.target.value;
            sortAndFilterModels();
            renderGallery();
        }

        function handleFilterChange(e) {
            currentFilters.format = e.target.value;
            sortAndFilterModels();
            renderGallery();
        }

        function handleSearch(e) {
            currentFilters.search = e.target.value.toLowerCase();
            sortAndFilterModels();
            renderGallery();
        }

        function handleFavoritesFilter(e) {
            currentFilters.favorites = e.target.value;
            sortAndFilterModels();
            renderGallery();
        }

        function toggleTagFilter(tag) {
            const chip = document.querySelector(`[data-tag="${tag}"]`);
            const isSelected = currentFilters.tags.has(tag);
            
            if (isSelected) {
                currentFilters.tags.delete(tag);
                chip.classList.remove('selected');
                chip.setAttribute('aria-pressed', 'false');
            } else {
                currentFilters.tags.add(tag);
                chip.classList.add('selected');
                chip.setAttribute('aria-pressed', 'true');
            }
            
            sortAndFilterModels();
            renderGallery();
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            
            document.querySelector(`[onclick="setViewMode('${mode}')"]`).classList.add('active');
            document.querySelector(`[onclick="setViewMode('${mode}')"]`).setAttribute('aria-selected', 'true');
            
            renderGallery();
        }

        function sortAndFilterModels() {
            filteredModels = allModels.filter(model => {
                // Format filter
                if (currentFilters.format !== 'all' && 
                    model.format.toLowerCase() !== currentFilters.format.toLowerCase()) {
                    return false;
                }
                
                // Search filter
                if (currentFilters.search) {
                    const searchTerm = currentFilters.search;
                    const searchable = `${model.name} ${model.description} ${model.tags.join(' ')}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Favorites filter
                if (currentFilters.favorites === 'favorites' && !favorites.has(model.id)) {
                    return false;
                }
                
                if (currentFilters.favorites === 'recent' && !recentlyViewed.has(model.id)) {
                    return false;
                }
                
                // Tag filter
                if (currentFilters.tags.size > 0) {
                    const hasTag = Array.from(currentFilters.tags).some(tag => 
                        model.tags.includes(tag)
                    );
                    if (!hasTag) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Sort models
            filteredModels.sort((a, b) => {
                switch (currentSort) {
                    case 'size':
                        return b.size - a.size;
                    case 'confidence':
                        return b.confidence - a.confidence;
                    case 'favorites':
                        return b.favoriteCount - a.favoriteCount;
                    case 'recent':
                        // Favorites first, then by name
                        if (favorites.has(a.id) && !favorites.has(b.id)) return -1;
                        if (!favorites.has(a.id) && favorites.has(b.id)) return 1;
                        return a.name.localeCompare(b.name);
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });
        }

        // Favorites Management
        function toggleFavorite(modelId) {
            const btn = document.querySelector(`[onclick*="toggleFavorite('${modelId}')"]`);
            const model = allModels.find(m => m.id === modelId);
            
            if (favorites.has(modelId)) {
                favorites.delete(modelId);
                btn.classList.remove('favorited');
                btn.innerHTML = '🤍';
                btn.setAttribute('aria-label', 'Add to favorites');
                btn.title = 'Add to favorites';
                model.favoriteCount = Math.max(0, model.favoriteCount - 1);
            } else {
                favorites.add(modelId);
                btn.classList.add('favorited');
                btn.innerHTML = '❤️';
                btn.setAttribute('aria-label', 'Remove from favorites');
                btn.title = 'Remove from favorites';
                model.favoriteCount += 1;
            }
            
            saveFavorites();
            
            // Update display if viewing favorites
            if (currentFilters.favorites === 'favorites') {
                sortAndFilterModels();
                renderGallery();
            }
        }

        function saveFavorites() {
            try {
                localStorage.setItem('painaidee_favorites', JSON.stringify(Array.from(favorites)));
            } catch (error) {
                console.warn('Failed to save favorites:', error);
            }
        }

        function loadUserData() {
            try {
                // Load favorites
                const savedFavorites = localStorage.getItem('painaidee_favorites');
                if (savedFavorites) {
                    favorites = new Set(JSON.parse(savedFavorites));
                }
                
                // Load recently viewed
                const savedRecent = localStorage.getItem('painaidee_recent');
                if (savedRecent) {
                    recentlyViewed = new Set(JSON.parse(savedRecent));
                }
            } catch (error) {
                console.warn('Failed to load user data:', error);
            }
        }

        // Modal and Navigation
        function showModelDetails(modelName) {
            const model = allModels.find(m => m.name === modelName);
            if (!model) return;
            
            // Add to recently viewed
            recentlyViewed.add(model.id);
            try {
                localStorage.setItem('painaidee_recent', JSON.stringify(Array.from(recentlyViewed)));
            } catch (error) {
                console.warn('Failed to save recent views:', error);
            }
            
            // Show modal with enhanced details
            const modal = document.getElementById('modelModal');
            document.getElementById('modalTitle').textContent = model.name;
            document.getElementById('modalBody').innerHTML = createModalContent(model);
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            
            // Focus management
            modal.querySelector('.close-btn').focus();
        }

        function createModalContent(model) {
            const isFavorited = favorites.has(model.id);
            
            return `
                <div class="modal-preview" style="height: 300px; margin-bottom: 20px; background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 10px; position: relative;">
                    <div class="confidence-badge ${getConfidenceLevel(model.confidence)}" style="position: absolute; top: 15px; right: 15px;">
                        AI Confidence: ${Math.round(model.confidence * 100)}%
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 80px;">
                        ${model.icon}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #ffdd59; margin-bottom: 5px;">${model.name}</h3>
                            <p style="color: #ccc; margin: 0;">${model.description}</p>
                        </div>
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" 
                                onclick="toggleFavorite('${model.id}')"
                                style="font-size: 24px;">
                            ${isFavorited ? '❤️' : '🤍'}
                        </button>
                    </div>
                    
                    <div class="model-tags" style="margin-bottom: 20px;">
                        ${model.tags.map(tag => `
                            <span class="model-tag ${model.aiGenerated ? 'ai-generated' : ''}">${tag}</span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 25px;">
                    <div class="stat-item">
                        <div class="stat-label">File Size</div>
                        <div class="stat-value">${formatFileSize(model.size)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Format</div>
                        <div class="stat-value">${model.format}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Views</div>
                        <div class="stat-value">${model.viewCount}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Favorites</div>
                        <div class="stat-value">${model.favoriteCount}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">AI Score</div>
                        <div class="stat-value">${Math.round(model.confidence * 100)}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Quality</div>
                        <div class="stat-value">HD</div>
                    </div>
                </div>
                
                <div class="model-actions" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-primary" onclick="loadModel('${model.name}')" style="font-size: 14px; padding: 12px 20px;">
                        🎮 Open in 3D Viewer
                    </button>
                    <a href="/models/${model.name}" class="btn btn-secondary" style="font-size: 14px; padding: 12px 20px;">
                        📥 Download Model
                    </a>
                </div>
            `;
        }

        function closeModal() {
            const modal = document.getElementById('modelModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }

        function loadModel(modelName) {
            // Navigate to 3D viewer with the selected model
            window.location.href = `/static/demo.html?model=${modelName}&enhanced=true`;
        }

        // Keyboard Navigation and Accessibility
        function handleKeyboardNavigation(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
            
            if (e.key === '/' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Arrow key navigation for model cards
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                handleCardNavigation(e);
            }
        }

        function handleCardNavigation(e) {
            const cards = Array.from(document.querySelectorAll('.model-card'));
            const currentIndex = cards.findIndex(card => card === document.activeElement);
            
            if (currentIndex === -1) return;
            
            let nextIndex = currentIndex;
            const cardsPerRow = Math.floor(window.innerWidth / 320); // Approximate cards per row
            
            switch (e.key) {
                case 'ArrowLeft':
                    nextIndex = Math.max(0, currentIndex - 1);
                    break;
                case 'ArrowRight':
                    nextIndex = Math.min(cards.length - 1, currentIndex + 1);
                    break;
                case 'ArrowUp':
                    nextIndex = Math.max(0, currentIndex - cardsPerRow);
                    break;
                case 'ArrowDown':
                    nextIndex = Math.min(cards.length - 1, currentIndex + cardsPerRow);
                    break;
            }
            
            if (nextIndex !== currentIndex) {
                e.preventDefault();
                cards[nextIndex].focus();
            }
        }

        function handleCardKeydown(event, modelName) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                showModelDetails(modelName);
            }
        }

        function handlePreviewResize(entries) {
            entries.forEach(entry => {
                const modelId = entry.target.id.replace('preview-', '');
                const previewData = previewScenes.get(modelId);
                
                if (previewData) {
                    const { renderer } = previewData;
                    const rect = entry.contentRect;
                    renderer.setSize(rect.width, rect.height);
                }
            });
        }

        function showError(message) {
            const gallery = document.getElementById('galleryGrid');
            gallery.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #ff6b6b;">
                    <div style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
                    <h3 style="margin-bottom: 10px;">Error Loading Gallery</h3>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                        🔄 Retry
                    </button>
                </div>
            `;
            gallery.style.display = 'grid';
        }

        // Performance optimization: Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            previewRenderers.forEach(renderer => {
                renderer.dispose();
            });
        });
        
        console.log('Enhanced 3D Model Gallery with Live Previews, Smart Tagging, and Favorites initialized successfully! 🎮🎨');
    </script>
</body>
</html>